name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  cpp-build:
    name: C++ Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest]
        include:
          - os: windows-latest
            compiler: msvc
          - os: ubuntu-latest
            compiler: gcc-12

    steps:
      - uses: actions/checkout@v4

      # Setup vcpkg (with caching)
      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: 'latest'

      # Configure CMake
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake -DCMAKE_BUILD_TYPE=Release

      # Build C++ Core
      - name: Build C++ Core
        run: cmake --build build --config Release

      # Build Python Bridge
      - name: Build Python Bridge
        run: cmake --build build --config Release --target hqt_core_ext

      # Run C++ Tests
      - name: Run C++ Tests
        run: cd build && ctest -C Release --output-on-failure

  python-test:
    name: Python Tests & Coverage
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e ".[dev,test]"

      - name: Run pytest with coverage
        run: |
          pytest tests/ --cov=hqt --cov-report=xml --cov-report=term -m "not benchmark"

      - name: Run E2E tests (without bridge)
        run: |
          pytest tests/integration/test_engine_e2e.py -v
        continue-on-error: true  # Bridge may not be built in Python-only job

      - name: Run benchmarks
        run: |
          pytest tests/integration/test_engine_performance.py -m benchmark -v -s
        continue-on-error: true  # Bridge may not be built in Python-only job

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false  # Don't fail CI if Codecov upload fails

  static-analysis:
    name: Static Analysis (Ruff + Mypy)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy

      - name: Ruff check
        run: ruff check .

      - name: Ruff format check
        run: ruff format --check .

      - name: Mypy type checking
        run: mypy src/hqt --ignore-missing-imports
        continue-on-error: true  # Gradual typing in progress

  bridge-e2e:
    name: Bridge E2E Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e ".[dev,test]"

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: 'latest'

      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake -DCMAKE_BUILD_TYPE=Release

      - name: Build C++ Core
        run: cmake --build build --config Release

      - name: Build Python Bridge
        run: cmake --build build --config Release --target hqt_core_ext

      - name: Add bridge to PYTHONPATH
        run: echo "PYTHONPATH=$PYTHONPATH:$(pwd)/build/bridge" >> $GITHUB_ENV

      - name: Run E2E integration tests
        run: |
          pytest tests/integration/test_engine_e2e.py -v --tb=short

      - name: Run performance benchmarks
        run: |
          pytest tests/integration/test_engine_performance.py -m benchmark -v -s --tb=short

  sanitizers:
    name: Memory Sanitizers (ASan + UBSan)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install GCC-12
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-12 g++-12

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: 'latest'

      - name: Configure CMake with sanitizers
        env:
          CC: gcc-12
          CXX: g++-12
          CXXFLAGS: -fsanitize=address,undefined -fno-omit-frame-pointer
          LDFLAGS: -fsanitize=address,undefined
        run: |
          cmake -B build -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake -DCMAKE_BUILD_TYPE=Debug

      - name: Build C++ Core with sanitizers
        run: cmake --build build --config Debug

      - name: Build Bridge with sanitizers
        run: cmake --build build --config Debug --target hqt_core_ext
        continue-on-error: true  # Bridge may have issues with sanitizers

      - name: Run C++ tests under sanitizers
        run: cd build && ctest -C Debug --output-on-failure
        env:
          ASAN_OPTIONS: detect_leaks=1:check_initialization_order=1:halt_on_error=0
          UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=0

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [cpp-build, python-test, static-analysis, bridge-e2e, sanitizers]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.cpp-build.result }}" == "failure" ]] || \
             [[ "${{ needs.python-test.result }}" == "failure" ]] || \
             [[ "${{ needs.static-analysis.result }}" == "failure" ]] || \
             [[ "${{ needs.bridge-e2e.result }}" == "failure" ]] || \
             [[ "${{ needs.sanitizers.result }}" == "failure" ]]; then
            echo "One or more CI jobs failed"
            exit 1
          fi
          echo "All CI jobs passed!"
